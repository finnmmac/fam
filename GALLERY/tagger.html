<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gallery Tagger</title>
<style>
html, body {
    margin: 0;
    height: 100%;
    background: #111;
    color: #eee;
    font-family: system-ui, sans-serif;
}
body { display: flex; flex-direction: column; }
#viewer { flex: 1; display: flex; align-items: center; justify-content: center; }
#viewer img { max-width: 100%; max-height: 100%; }
#controls {
    background: #000; padding: 16px;
    display: grid; grid-template-columns: repeat(3,1fr) auto; gap: 10px;
}
input, button {
    padding: 10px; background: #222; border: 1px solid #444; color: #eee;
}
input:not(:placeholder-shown) { border-color: #0f0; }
button { cursor: pointer; }
</style>
</head>
<body>

<div id="viewer"><img id="img"></div>
<div id="controls">
    <input id="who" placeholder="Who">
    <input id="what" placeholder="What">
    <input id="where" placeholder="Where">
    <button id="save">Save</button>
</div>
<select id="imageSelect" hidden></select>

<script>
let data = [];
let files = [];
let current = null;

const img = document.getElementById("img");
const who = document.getElementById("who");
const what = document.getElementById("what");
const where = document.getElementById("where");
const saveBtn = document.getElementById("save");
const imageSelect = document.getElementById("imageSelect");

async function load() {
    data = await fetch("data.json").then(r => r.json());
    files = await fetch("images.json").then(r => r.json());

    imageSelect.innerHTML = "";
    files.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        imageSelect.appendChild(opt);
    });
    imageSelect.selectedIndex = 0;
    loadImage();
}

function loadImage() {
    const name = imageSelect.value;
    if (!name) return;

    const src = "images/" + name;
    img.src = src;

    current = data.find(d => d.src === src);
    if (!current) {
        current = { src, who: "", what: "", where: "" };
        data.push(current);
    }

    who.value = current.who;
    what.value = current.what;
    where.value = current.where;
}

function nextUntagged() {
    for (let i = imageSelect.selectedIndex + 1; i < files.length; i++) {
        const src = "images/" + files[i];
        const entry = data.find(d => d.src === src);
        if (!entry || !entry.who || !entry.what || !entry.where) {
            imageSelect.selectedIndex = i;
            loadImage();
            return;
        }
    }
    alert("All images tagged");
}

async function save() {
    current.who = who.value.trim();
    current.what = what.value.trim();
    current.where = where.value.trim();

    await fetch("data.json", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data, null, 2)
    });

    nextUntagged();
}

saveBtn.onclick = save;

// keyboard shortcuts
document.addEventListener("keydown", e => {
    if (e.key === "Enter") { e.preventDefault(); save(); }
    if (e.key === "ArrowRight" && imageSelect.selectedIndex < files.length - 1) {
        imageSelect.selectedIndex++; loadImage();
    }
    if (e.key === "ArrowLeft" && imageSelect.selectedIndex > 0) {
        imageSelect.selectedIndex--; loadImage();
    }
});

load();
</script>

</body>
</html>
